{% extends "base.html" %}

{% block page_title %}Documenti{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-folder-open"></i> Lista Documenti</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" onclick="loadDocuments()">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="text" class="form-control" id="filter-name" placeholder="Filtra per nome...">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="applyFilters()">
                                    <i class="fas fa-filter"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="filter-type">
                            <option value="">Tutti i tipi</option>
                            <option value=".pdf">PDF</option>
                            <option value=".docx">Word</option>
                            <option value=".xlsx">Excel</option>
                            <option value=".html">HTML</option>
                            <option value=".md">Markdown</option>
                            <option value=".txt">Text</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-control" id="sort-by">
                            <option value="indexed_at">Data</option>
                            <option value="filename">Nome</option>
                            <option value="size">Dimensione</option>
                        </select>
                    </div>
                </div>

                <!-- Loading -->
                <div id="docs-loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Caricamento...</span>
                    </div>
                </div>

                <!-- Documents Table -->
                <div id="docs-container">
                    <table class="table table-hover" id="docs-table">
                        <thead>
                            <tr>
                                <th>Documento</th>
                                <th>Tipo</th>
                                <th>Dimensione</th>
                                <th>Indicizzato</th>
                                <th>Keywords/Tags</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="docs-tbody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div id="docs-info">Mostrando 0 documenti</div>
                    </div>
                    <div class="col-md-6">
                        <nav>
                            <ul class="pagination justify-content-end" id="pagination">
                                <!-- Dynamic pagination -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Detail Modal -->
<div class="modal fade" id="doc-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">Dettagli Documento</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <a id="modal-download-btn" href="#" class="btn btn-success" target="_blank">
                    <i class="fas fa-download"></i> Scarica File
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allDocuments = [];
let currentPage = 1;
const pageSize = 20;

// Load documents on page load
$(document).ready(function() {
    loadDocuments();
});

function loadDocuments() {
    $('#docs-loading').show();
    $('#docs-container').hide();

    $.ajax({
        url: '/api/documents?size=100',
        method: 'GET',
        success: function(response) {
            $('#docs-loading').hide();
            $('#docs-container').show();

            if (response.success) {
                allDocuments = response.documents;
                renderDocuments();
            } else {
                showError(response.error);
            }
        },
        error: function(xhr, status, error) {
            $('#docs-loading').hide();
            showError('Errore durante il caricamento: ' + error);
        }
    });
}

function renderDocuments() {
    const tbody = $('#docs-tbody');
    tbody.empty();

    if (allDocuments.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="6" class="text-center text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Nessun documento trovato</p>
                    <a href="/upload" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Carica il primo documento
                    </a>
                </td>
            </tr>
        `);
        return;
    }

    // Paginate
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageDocuments = allDocuments.slice(start, end);

    pageDocuments.forEach(doc => {
        const keywords = (doc.keywords || []).slice(0, 3).map(kw =>
            `<span class="badge badge-secondary">${kw}</span>`
        ).join(' ');

        const tags = (doc.tags || []).map(tag =>
            `<span class="badge badge-success"><i class="fas fa-tag"></i> ${tag}</span>`
        ).join(' ');

        const keywordsTags = [keywords, tags].filter(x => x).join(' ');

        const date = new Date(doc.indexed_at).toLocaleString('it-IT');

        const row = `
            <tr>
                <td>
                    <i class="fas fa-file-${getFileIcon(doc.extension)} text-primary"></i>
                    <strong>${getDisplayFilename(doc.filename)}</strong>
                </td>
                <td><span class="badge badge-info">${doc.type}</span></td>
                <td>${formatSize(doc.file_size)}</td>
                <td><small>${date}</small></td>
                <td>${keywordsTags || '<em class="text-muted">Nessuno</em>'}</td>
                <td class="text-nowrap">
                    <a href="/api/download/${doc.id}" class="btn btn-sm btn-success" target="_blank" title="Scarica file">
                        <i class="fas fa-download"></i> Scarica
                    </a>
                    <button class="btn btn-sm btn-info" onclick="viewDocument('${doc.id}')" title="Vedi dettagli">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDocument('${doc.id}', '${doc.filename}')" title="Elimina documento">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;

        tbody.append(row);
    });

    // Update info
    $('#docs-info').text(`Mostrando ${allDocuments.length} documenti`);

    // Render pagination
    renderPagination();
}

function renderPagination() {
    const totalPages = Math.ceil(allDocuments.length / pageSize);
    const pagination = $('#pagination');
    pagination.empty();

    if (totalPages <= 1) return;

    // Previous
    pagination.append(`
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `);

    // Pages
    for (let i = 1; i <= totalPages; i++) {
        pagination.append(`
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `);
    }

    // Next
    pagination.append(`
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `);
}

function changePage(page) {
    const totalPages = Math.ceil(allDocuments.length / pageSize);
    if (page < 1 || page > totalPages) return;

    currentPage = page;
    renderDocuments();
}

function viewDocument(docId) {
    $.ajax({
        url: `/api/document/${docId}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                showDocumentDetail(response.document);
            } else {
                showError(response.error);
            }
        },
        error: function(xhr, status, error) {
            showError('Errore: ' + error);
        }
    });
}

function showDocumentDetail(doc) {
    $('#modal-title').text(getDisplayFilename(doc.filename));

    const keywords = (doc.keywords || []).map(kw =>
        `<span class="badge badge-secondary">${kw}</span>`
    ).join(' ');

    const tags = (doc.tags || []).map(tag =>
        `<span class="badge badge-success"><i class="fas fa-tag"></i> ${tag}</span>`
    ).join(' ');

    let tagsHtml = '';
    if (tags) {
        tagsHtml = `
            <hr>
            <div>
                <strong>Tags:</strong><br>
                ${tags}
            </div>
        `;
    }

    const modalContent = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Tipo:</strong> ${doc.type}</p>
                <p><strong>Estensione:</strong> ${doc.extension}</p>
                <p><strong>Dimensione:</strong> ${formatSize(doc.file_size)}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Indicizzato:</strong> ${new Date(doc.indexed_at).toLocaleString('it-IT')}</p>
                <p><strong>Path:</strong> <code>${doc.file_path}</code></p>
            </div>
        </div>
        <hr>
        <div>
            <strong>Keywords:</strong><br>
            ${keywords || '<em class="text-muted">Nessuno</em>'}
        </div>
        ${tagsHtml}
        <hr>
        <div>
            <strong>Summary:</strong>
            <p>${doc.summary}</p>
        </div>
        <hr>
        <div>
            <strong>Contenuto (anteprima):</strong>
            <pre style="max-height: 300px; overflow-y: auto;">${doc.content.substring(0, 1000)}...</pre>
        </div>
    `;

    $('#modal-body').html(modalContent);

    // Aggiorna link download nel modale
    $('#modal-download-btn').attr('href', `/api/download/${doc.id}`);

    $('#doc-modal').modal('show');
}

function deleteDocument(docId, filename) {
    if (!confirm(`Sei sicuro di voler eliminare "${filename}"?`)) {
        return;
    }

    $.ajax({
        url: `/api/document/${docId}`,
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                alert('✅ Documento eliminato con successo');
                loadDocuments();
            } else {
                showError(response.error);
            }
        },
        error: function(xhr, status, error) {
            showError('Errore durante l\'eliminazione: ' + error);
        }
    });
}

function applyFilters() {
    // TODO: Implement filters
    alert('Filtri in via di implementazione');
}

function getDisplayFilename(filename) {
    // Rimuovi timestamp dal nome file (formato: YYYYMMDD_HHMMSS_* o YYYYMMDD_HHMMSS_MICROSECONDS_*)
    // Esempi: 20251110_114757_557040_file.pdf -> file.pdf
    //         20251110_114757_file.pdf -> file.pdf
    if (filename.match(/^\d{8}_\d{6}_(\d+_)?/)) {
        // Trova la posizione dopo il timestamp
        const parts = filename.split('_');
        if (parts.length >= 3) {
            // Se c'è un terzo gruppo di cifre (microsecondi), rimuovi anche quello
            if (parts[2] && /^\d+$/.test(parts[2])) {
                return parts.slice(3).join('_');
            }
            // Altrimenti rimuovi solo data e ora
            return parts.slice(2).join('_');
        }
    }
    return filename;
}

function getFileIcon(extension) {
    const icons = {
        '.pdf': 'pdf',
        '.doc': 'word',
        '.docx': 'word',
        '.xls': 'excel',
        '.xlsx': 'excel',
        '.html': 'code',
        '.md': 'markdown',
        '.txt': 'alt',
        '.csv': 'csv',
        '.msg': 'envelope',
        '.pst': 'archive'
    };
    return icons[extension] || 'alt';
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / 1024 / 1024).toFixed(2) + ' MB';
}

function showError(message) {
    alert('Errore: ' + message);
}
</script>
{% endblock %}
