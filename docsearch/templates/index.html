{% extends "base.html" %}

{% block page_title %}Ricerca Intelligente{% endblock %}

{% block content %}
<!-- Statistiche -->
<div class="row mb-4">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info stat-card">
            <div class="inner">
                <h3>{{ stats.total_documents }}</h3>
                <p>Documenti Totali</p>
            </div>
            <div class="icon">
                <i class="fas fa-file-alt"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success stat-card">
            <div class="inner">
                <h3>{{ "%.1f"|format(stats.total_size / 1024 / 1024) }}</h3>
                <p>MB di Contenuti</p>
            </div>
            <div class="icon">
                <i class="fas fa-database"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning stat-card">
            <div class="inner">
                <h3>{{ stats.by_type|length }}</h3>
                <p>Tipi di Documento</p>
            </div>
            <div class="icon">
                <i class="fas fa-tags"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-danger stat-card">
            <div class="inner">
                <h3 id="search-count">0</h3>
                <p>Ricerche Effettuate</p>
            </div>
            <div class="icon">
                <i class="fas fa-search"></i>
            </div>
        </div>
    </div>
</div>

<!-- Tags Disponibili -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-tags"></i> Filtra per Tag</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" id="clear-tag-filter" style="display: none;">
                        <i class="fas fa-times"></i> Rimuovi Filtro
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="tags-container">
                    <span class="text-muted">Caricamento tags...</span>
                </div>
                <input type="hidden" id="selected-tag">
            </div>
        </div>
    </div>
</div>

<!-- Form Ricerca -->
<div class="row">
    <div class="col-md-12">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-magic"></i> Ricerca Intelligente</h3>
            </div>
            <div class="card-body">
                <form id="search-form">
                    <div class="input-group input-group-lg">
                        <input
                            type="text"
                            class="form-control form-control-lg"
                            id="search-query"
                            placeholder="Chiedi qualsiasi cosa... Es: Come installare OpenSearch?"
                            required>
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i> Cerca
                            </button>
                        </div>
                    </div>
                    <small class="form-text text-muted">
                        ðŸ’¡ Scrivi una domanda o parole chiave. Il sistema ti fornirÃ  una risposta intelligente con percorsi di approfondimento.
                    </small>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading -->
<div id="loading" class="row" style="display: none;">
    <div class="col-md-12 text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="sr-only">Ricerca in corso...</span>
        </div>
        <p class="mt-3">Sto analizzando i documenti...</p>
    </div>
</div>

<!-- Risposta Intelligente -->
<div id="answer-section" class="row" style="display: none;">
    <div class="col-md-12">
        <!-- Answer Card -->
        <div class="card card-success">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-robot"></i> Risposta Intelligente</h3>
            </div>
            <div class="card-body">
                <div id="answer-text" class="mb-3"></div>

                <div class="row">
                    <div class="col-md-6">
                        <strong><i class="fas fa-chart-line"></i> Confidenza:</strong>
                        <div class="confidence-bar mt-2">
                            <div class="confidence-fill" id="confidence-fill" style="width: 0%"></div>
                        </div>
                        <small id="confidence-text" class="text-muted"></small>
                    </div>
                    <div class="col-md-6">
                        <strong><i class="fas fa-file"></i> Fonti:</strong>
                        <div id="sources-list" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flow Card -->
        <div class="card card-info">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-route"></i> Percorso di Approfondimento</h3>
            </div>
            <div class="card-body">
                <div id="flow-steps"></div>
            </div>
        </div>

        <!-- Suggestions -->
        <div class="card card-warning">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-lightbulb"></i> Suggerimenti</h3>
            </div>
            <div class="card-body">
                <div id="suggestions-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- Risultati Ricerca -->
<div id="results-section" class="row" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-list"></i> Documenti Trovati (<span id="results-count">0</span>)</h3>
            </div>
            <div class="card-body" id="results-container">
                <!-- Risultati dinamici -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let searchCounter = 0;
let allTags = [];

// Load tags on page load
$(document).ready(function() {
    loadTags();
});

function loadTags() {
    $.ajax({
        url: '/api/tags',
        method: 'GET',
        success: function(response) {
            if (response.success && response.tags.length > 0) {
                allTags = response.tags;
                renderTags();
            } else {
                $('#tags-container').html('<span class="text-muted"><em>Nessun tag disponibile</em></span>');
            }
        },
        error: function() {
            $('#tags-container').html('<span class="text-danger"><em>Errore caricamento tags</em></span>');
        }
    });
}

function renderTags() {
    const selectedTag = $('#selected-tag').val();
    let html = '';

    allTags.forEach(tag => {
        const isSelected = tag.tag === selectedTag;
        const badgeClass = isSelected ? 'badge-primary' : 'badge-success';
        html += `
            <button class="btn btn-sm ${badgeClass} m-1 tag-filter-btn" data-tag="${tag.tag}">
                <i class="fas fa-tag"></i> ${tag.tag} (${tag.count})
            </button>
        `;
    });

    $('#tags-container').html(html);

    // Handle tag click
    $('.tag-filter-btn').on('click', function() {
        const tag = $(this).data('tag');
        selectTag(tag);
    });
}

function selectTag(tag) {
    $('#selected-tag').val(tag);
    $('#clear-tag-filter').show();
    renderTags();

    // Auto-search se c'Ã¨ una query
    const query = $('#search-query').val().trim();
    if (query) {
        performSearch(query);
    }
}

// Clear tag filter
$('#clear-tag-filter').on('click', function() {
    $('#selected-tag').val('');
    $(this).hide();
    renderTags();

    // Auto-search se c'Ã¨ una query
    const query = $('#search-query').val().trim();
    if (query) {
        performSearch(query);
    }
});

// Handle search form
$('#search-form').on('submit', function(e) {
    e.preventDefault();

    const query = $('#search-query').val().trim();
    if (!query) return;

    performSearch(query);
});

function performSearch(query) {
    // Update counter
    searchCounter++;
    $('#search-count').text(searchCounter);

    // Show loading
    $('#loading').show();
    $('#answer-section').hide();
    $('#results-section').hide();

    // Get selected tag filter
    const tagFilter = $('#selected-tag').val();

    // API call
    $.ajax({
        url: '/api/search',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            query: query,
            size: 10,
            use_rag: true,
            tag_filter: tagFilter
        }),
        success: function(response) {
            $('#loading').hide();

            if (response.success) {
                displayAnswer(response);
                displayResults(response.results);
            } else {
                showError(response.error);
            }
        },
        error: function(xhr, status, error) {
            $('#loading').hide();
            showError('Errore durante la ricerca: ' + error);
        }
    });
}

function displayAnswer(response) {
    // Answer text
    $('#answer-text').html(response.answer.replace(/\n/g, '<br>'));

    // Confidence
    const confidence = response.confidence * 100;
    $('#confidence-fill').css('width', confidence + '%');
    $('#confidence-text').text(`${confidence.toFixed(0)}% - ${getConfidenceLabel(response.confidence)}`);

    // Sources
    let sourcesHtml = '<ul class="list-unstyled">';
    response.sources.forEach(source => {
        sourcesHtml += `
            <li>
                <i class="fas fa-file text-primary"></i>
                <strong>${source.filename}</strong>
                <span class="badge badge-info">${source.score}</span>
            </li>
        `;
    });
    sourcesHtml += '</ul>';
    $('#sources-list').html(sourcesHtml);

    // Flow
    let flowHtml = '';
    response.flow.forEach((step, index) => {
        flowHtml += `
            <div class="flow-step">
                <strong>${step}</strong>
            </div>
        `;
    });
    $('#flow-steps').html(flowHtml);

    // Suggestions
    let suggestionsHtml = '';
    response.suggestions.forEach(suggestion => {
        suggestionsHtml += `
            <button class="btn btn-sm btn-outline-warning m-1 suggestion-btn">
                <i class="fas fa-arrow-right"></i> ${suggestion}
            </button>
        `;
    });
    $('#suggestions-list').html(suggestionsHtml);

    // Suggestion click handlers
    $('.suggestion-btn').on('click', function() {
        const suggestion = $(this).text().replace('Cerca anche: ', '').trim();
        $('#search-query').val(suggestion);
        performSearch(suggestion);
    });

    $('#answer-section').show();
}

function displayResults(results) {
    $('#results-count').text(results.length);

    if (results.length === 0) {
        $('#results-container').html(`
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Nessun documento trovato per questa ricerca.
            </div>
        `);
        $('#results-section').show();
        return;
    }

    let html = '';
    results.forEach((result, index) => {
        const keywords = result.keywords.slice(0, 5).map(kw =>
            `<span class="keyword-badge">${kw}</span>`
        ).join(' ');

        const tags = (result.tags || []).map(tag =>
            `<span class="badge badge-success clickable-tag" data-tag="${tag}" style="cursor: pointer;">
                <i class="fas fa-tag"></i> ${tag}
            </span>`
        ).join(' ');

        // Badge se Ã¨ allegato
        const attachmentBadge = result.is_attachment ?
            `<span class="badge badge-warning ml-2"><i class="fas fa-paperclip"></i> Allegato</span>` : '';

        // Informazione parent
        const parentInfo = result.parent_filename ?
            `<small class="text-muted d-block"><i class="fas fa-level-up-alt"></i> Da: ${result.parent_filename}</small>` : '';

        // Data indicizzazione
        const indexedDate = result.indexed_at ? new Date(result.indexed_at).toLocaleString('it-IT') : '';

        html += `
            <div class="card search-result mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-9">
                            <h5 class="card-title">
                                <i class="fas fa-file-${getFileIcon(result.extension)} text-primary"></i>
                                ${result.filename}
                                <span class="badge badge-primary">${result.score.toFixed(2)}</span>
                                ${attachmentBadge}
                            </h5>
                            ${parentInfo}
                            <p class="card-text">
                                <span class="badge badge-secondary">${result.type}</span>
                                ${result.extension}
                                <small class="text-muted ml-2">
                                    <i class="fas fa-clock"></i> ${indexedDate}
                                </small>
                            </p>
                            <div class="highlight mb-2">
                                ${result.highlight}
                            </div>
                            <div class="mt-2">
                                ${keywords}
                                ${tags}
                            </div>
                        </div>
                        <div class="col-md-3 text-right">
                            <div class="btn-group-vertical btn-group-sm" role="group">
                                <button class="btn btn-info mb-2" onclick="viewDocument('${result.id}')">
                                    <i class="fas fa-eye"></i> Visualizza
                                </button>
                                <button class="btn btn-success mb-2" onclick="downloadDocument('${result.id}')">
                                    <i class="fas fa-download"></i> Scarica
                                </button>
                                <button class="btn btn-secondary" onclick="openInNewTab('${result.id}')">
                                    <i class="fas fa-external-link-alt"></i> Apri
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    $('#results-container').html(html);

    // Make tags clickable
    $('.clickable-tag').on('click', function() {
        const tag = $(this).data('tag');
        selectTag(tag);

        // Scroll to top
        $('html, body').animate({
            scrollTop: $('#tags-container').offset().top - 100
        }, 500);
    });

    $('#results-section').show();
}

function viewDocument(docId) {
    // Mostra modal con dettagli documento
    $.ajax({
        url: `/api/document/${docId}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                showDocumentModal(response.document);
            } else {
                showError('Errore: ' + response.error);
            }
        },
        error: function(xhr, status, error) {
            showError('Errore nel caricamento del documento: ' + error);
        }
    });
}

function showDocumentModal(doc) {
    // Crea e mostra modal con dettagli documento
    const keywords = (doc.keywords || []).map(kw =>
        `<span class="badge badge-secondary">${kw}</span>`
    ).join(' ');

    const tags = (doc.tags || []).map(tag =>
        `<span class="badge badge-success"><i class="fas fa-tag"></i> ${tag}</span>`
    ).join(' ');

    let tagsHtml = '';
    if (tags) {
        tagsHtml = `
            <hr>
            <div>
                <strong>Tags:</strong><br>
                ${tags}
            </div>
        `;
    }

    // Badge se Ã¨ allegato
    let attachmentInfo = '';
    if (doc.is_attachment && doc.parent_filename) {
        attachmentInfo = `
            <div class="alert alert-info">
                <i class="fas fa-paperclip"></i> <strong>Allegato estratto da:</strong> ${doc.parent_filename}
            </div>
        `;
    }

    const modalContent = `
        ${attachmentInfo}
        <div class="row">
            <div class="col-md-6">
                <p><strong>Tipo:</strong> ${doc.type}</p>
                <p><strong>Estensione:</strong> ${doc.extension}</p>
                <p><strong>Dimensione:</strong> ${formatSize(doc.file_size || 0)}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Indicizzato:</strong> ${new Date(doc.indexed_at).toLocaleString('it-IT')}</p>
                <p><strong>Path:</strong> <code>${doc.file_path || ''}</code></p>
            </div>
        </div>
        <hr>
        <div>
            <strong>Keywords:</strong><br>
            ${keywords || '<em class="text-muted">Nessuno</em>'}
        </div>
        ${tagsHtml}
        <hr>
        <div>
            <strong>Summary:</strong>
            <p>${doc.summary || 'Nessun summary disponibile'}</p>
        </div>
        <hr>
        <div>
            <strong>Contenuto (anteprima):</strong>
            <pre style="max-height: 300px; overflow-y: auto; background: #f4f4f4; padding: 10px; border-radius: 5px;">${(doc.content || '').substring(0, 1000)}...</pre>
        </div>
        <div id="modal-attachments-section">
            <hr>
            <div class="d-flex align-items-center">
                <strong>Allegati:</strong>
                <div class="spinner-border spinner-border-sm ml-2" role="status">
                    <span class="sr-only">Caricamento...</span>
                </div>
            </div>
        </div>
    `;

    // Crea modal HTML
    const modalHtml = `
        <div class="modal fade" id="doc-details-modal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${doc.filename}</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        ${modalContent}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="downloadDocument('${doc.id}')">
                            <i class="fas fa-download"></i> Scarica
                        </button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Rimuovi modal esistente se presente
    $('#doc-details-modal').remove();

    // Aggiungi al body e mostra
    $('body').append(modalHtml);
    $('#doc-details-modal').modal('show');

    // Carica allegati se non Ã¨ giÃ  un allegato
    if (!doc.is_attachment) {
        loadAttachmentsForModal(doc.id);
    } else {
        $('#modal-attachments-section').remove();
    }
}

function loadAttachmentsForModal(docId) {
    $.ajax({
        url: `/api/document/${docId}/attachments`,
        method: 'GET',
        success: function(response) {
            if (response.success && response.attachments.length > 0) {
                const attachmentsList = response.attachments.map(att => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-file-${getFileIcon(att.extension)} text-primary"></i>
                            <strong>${att.filename}</strong>
                            <br>
                            <small class="text-muted">${att.type} - ${formatSize(att.file_size)}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-info" onclick="viewDocument('${att.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="downloadDocument('${att.id}')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </li>
                `).join('');

                $('#modal-attachments-section').html(`
                    <hr>
                    <div>
                        <strong><i class="fas fa-paperclip"></i> Allegati (${response.count}):</strong>
                        <ul class="list-group mt-2">
                            ${attachmentsList}
                        </ul>
                    </div>
                `);
            } else {
                $('#modal-attachments-section').html(`
                    <hr>
                    <div>
                        <strong>Allegati:</strong> <em class="text-muted">Nessuno</em>
                    </div>
                `);
            }
        },
        error: function() {
            $('#modal-attachments-section').html(`
                <hr>
                <div>
                    <strong>Allegati:</strong> <em class="text-danger">Errore durante il caricamento</em>
                </div>
            `);
        }
    });
}

function downloadDocument(docId) {
    // Apri URL download
    window.open(`/api/download/${docId}`, '_blank');
    showSuccess('Download avviato!');
}

function openInNewTab(docId) {
    // Apri documento in nuova tab
    window.open(`/api/download/${docId}`, '_blank');
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / 1024 / 1024).toFixed(2) + ' MB';
}

function getConfidenceLabel(confidence) {
    if (confidence >= 0.8) return 'Molto Alta';
    if (confidence >= 0.6) return 'Alta';
    if (confidence >= 0.4) return 'Media';
    if (confidence >= 0.2) return 'Bassa';
    return 'Molto Bassa';
}

function getFileIcon(extension) {
    const icons = {
        '.pdf': 'pdf',
        '.doc': 'word',
        '.docx': 'word',
        '.xls': 'excel',
        '.xlsx': 'excel',
        '.html': 'code',
        '.md': 'markdown',
        '.txt': 'alt',
        '.csv': 'csv',
        '.xml': 'code',
        '.msg': 'envelope',
        '.pst': 'archive'
    };
    return icons[extension] || 'alt';
}
</script>
{% endblock %}
