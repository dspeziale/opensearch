{% extends "base.html" %}

{% block page_title %}DocSearch - Sistema Documentale{% endblock %}

{% block content %}
<!-- Statistiche -->
<div class="row mb-4">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info stat-card">
            <div class="inner">
                <h3>{{ stats.total_documents }}</h3>
                <p>Documenti Totali</p>
            </div>
            <div class="icon">
                <i class="fas fa-file-alt"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success stat-card">
            <div class="inner">
                <h3>{{ "%.1f"|format(stats.total_size / 1024 / 1024) }}</h3>
                <p>MB di Contenuti</p>
            </div>
            <div class="icon">
                <i class="fas fa-database"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning stat-card">
            <div class="inner">
                <h3>{{ stats.by_type|length }}</h3>
                <p>Tipi di Documento</p>
            </div>
            <div class="icon">
                <i class="fas fa-tags"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-danger stat-card">
            <div class="inner">
                <h3 id="search-count">0</h3>
                <p>Ricerche Effettuate</p>
            </div>
            <div class="icon">
                <i class="fas fa-search"></i>
            </div>
        </div>
    </div>
</div>

<!-- Main Card with Tabs -->
<div class="row">
    <div class="col-md-12">
        <div class="card card-primary card-outline card-outline-tabs">
            <div class="card-header p-0 border-bottom-0">
                <ul class="nav nav-tabs" id="main-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="search-tab" data-toggle="pill" href="#search-content" role="tab" aria-controls="search-content" aria-selected="true">
                            <i class="fas fa-search"></i> Ricerca
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="documents-tab" data-toggle="pill" href="#documents-content" role="tab" aria-controls="documents-content" aria-selected="false">
                            <i class="fas fa-folder-open"></i> Documenti
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="main-tabs-content">
                    <!-- TAB: Ricerca -->
                    <div class="tab-pane fade show active" id="search-content" role="tabpanel" aria-labelledby="search-tab">
                        <!-- Tags Disponibili -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title"><i class="fas fa-tags"></i> Filtra per Tag</h5>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool btn-sm" id="clear-tag-filter" style="display: none;">
                                                <i class="fas fa-times"></i> Rimuovi Filtro
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="tags-container">
                                            <span class="text-muted">Caricamento tags...</span>
                                        </div>
                                        <input type="hidden" id="selected-tag">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Ricerca -->
                        <div class="row">
                            <div class="col-md-12">
                                <form id="search-form">
                                    <div class="input-group input-group-lg">
                                        <input
                                            type="text"
                                            class="form-control form-control-lg"
                                            id="search-query"
                                            placeholder="Chiedi qualsiasi cosa... Es: Come installare OpenSearch?"
                                            required>
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" type="submit">
                                                <i class="fas fa-search"></i> Cerca
                                            </button>
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">
                                        ðŸ’¡ Scrivi una domanda o parole chiave. Il sistema ti fornirÃ  una risposta intelligente con percorsi di approfondimento.
                                    </small>
                                </form>
                            </div>
                        </div>

                        <!-- Loading -->
                        <div id="loading" class="row mt-3" style="display: none;">
                            <div class="col-md-12 text-center">
                                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="sr-only">Ricerca in corso...</span>
                                </div>
                                <p class="mt-3">Sto analizzando i documenti...</p>
                            </div>
                        </div>

                        <!-- Risposta Intelligente -->
                        <div id="answer-section" class="row mt-3" style="display: none;">
                            <div class="col-md-12">
                                <!-- Answer Card -->
                                <div class="card card-success">
                                    <div class="card-header">
                                        <h5 class="card-title"><i class="fas fa-robot"></i> Risposta Intelligente</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="answer-text" class="mb-3"></div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong><i class="fas fa-chart-line"></i> Confidenza:</strong>
                                                <div class="confidence-bar mt-2">
                                                    <div class="confidence-fill" id="confidence-fill" style="width: 0%"></div>
                                                </div>
                                                <small id="confidence-text" class="text-muted"></small>
                                            </div>
                                            <div class="col-md-6">
                                                <strong><i class="fas fa-file"></i> Fonti:</strong>
                                                <div id="sources-list" class="mt-2"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Flow Card -->
                                <div class="card card-info">
                                    <div class="card-header">
                                        <h5 class="card-title"><i class="fas fa-route"></i> Percorso di Approfondimento</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="flow-steps"></div>
                                    </div>
                                </div>

                                <!-- Suggestions -->
                                <div class="card card-warning">
                                    <div class="card-header">
                                        <h5 class="card-title"><i class="fas fa-lightbulb"></i> Suggerimenti</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="suggestions-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Risultati Ricerca -->
                        <div id="results-section" class="row mt-3" style="display: none;">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title"><i class="fas fa-list"></i> Documenti Trovati (<span id="results-count">0</span>)</h5>
                                    </div>
                                    <div class="card-body" id="results-container">
                                        <!-- Risultati dinamici -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Documenti -->
                    <div class="tab-pane fade" id="documents-content" role="tabpanel" aria-labelledby="documents-tab">
                        <div class="card-tools float-right mb-3">
                            <button type="button" class="btn btn-primary" onclick="loadDocuments()">
                                <i class="fas fa-sync"></i> Aggiorna
                            </button>
                        </div>
                        <div class="clearfix"></div>

                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="filter-name" placeholder="Filtra per nome...">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="button" onclick="applyFilters()">
                                            <i class="fas fa-filter"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-control" id="filter-type">
                                    <option value="">Tutti i tipi</option>
                                    <option value=".pdf">PDF</option>
                                    <option value=".docx">Word</option>
                                    <option value=".xlsx">Excel</option>
                                    <option value=".html">HTML</option>
                                    <option value=".md">Markdown</option>
                                    <option value=".txt">Text</option>
                                    <option value=".json">JSON</option>
                                    <option value=".xml">XML</option>
                                    <option value=".zip">ZIP</option>
                                    <option value=".pptx">PowerPoint</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-control" id="sort-by">
                                    <option value="indexed_at">Data</option>
                                    <option value="filename">Nome</option>
                                    <option value="size">Dimensione</option>
                                </select>
                            </div>
                        </div>

                        <!-- Loading -->
                        <div id="docs-loading" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Caricamento...</span>
                            </div>
                        </div>

                        <!-- Documents Table -->
                        <div id="docs-container">
                            <table class="table table-hover" id="docs-table">
                                <thead>
                                    <tr>
                                        <th>Documento</th>
                                        <th>Tipo</th>
                                        <th>Dimensione</th>
                                        <th>Indicizzato</th>
                                        <th>Keywords/Tags</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="docs-tbody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div id="docs-info">Mostrando 0 documenti</div>
                            </div>
                            <div class="col-md-6">
                                <nav>
                                    <ul class="pagination justify-content-end" id="pagination">
                                        <!-- Dynamic pagination -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Detail Modal -->
<div class="modal fade" id="doc-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">Dettagli Documento</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <a id="modal-download-btn" href="#" class="btn btn-success" target="_blank">
                    <i class="fas fa-download"></i> Scarica File
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============ SHARED VARIABLES ============
let searchCounter = 0;
let allTags = [];
let allDocuments = [];
let filteredDocuments = [];
let currentPage = 1;
const pageSize = 20;

// ============ INITIALIZATION ============
$(document).ready(function() {
    loadTags();

    // Load documents when switching to documents tab
    $('#documents-tab').on('shown.bs.tab', function() {
        if (allDocuments.length === 0) {
            loadDocuments();
        }
    });

    // Event handlers per filtri documenti
    $('#filter-type').on('change', applyDocumentFilters);
    $('#sort-by').on('change', applyDocumentFilters);
    $('#filter-name').on('keyup', function(e) {
        if (e.key === 'Enter') {
            applyDocumentFilters();
        }
    });
});

// ============ TAB: RICERCA ============

function loadTags() {
    $.ajax({
        url: '/api/tags',
        method: 'GET',
        success: function(response) {
            if (response.success && response.tags.length > 0) {
                allTags = response.tags;
                renderTags();
            } else {
                $('#tags-container').html('<span class="text-muted"><em>Nessun tag disponibile</em></span>');
            }
        },
        error: function() {
            $('#tags-container').html('<span class="text-danger"><em>Errore caricamento tags</em></span>');
        }
    });
}

function renderTags() {
    const selectedTag = $('#selected-tag').val();
    let html = '';

    allTags.forEach(tag => {
        const isSelected = tag.tag === selectedTag;
        const badgeClass = isSelected ? 'badge-primary' : 'badge-success';
        html += `
            <button class="btn btn-sm ${badgeClass} m-1 tag-filter-btn" data-tag="${tag.tag}">
                <i class="fas fa-tag"></i> ${tag.tag} (${tag.count})
            </button>
        `;
    });

    $('#tags-container').html(html);

    // Handle tag click
    $('.tag-filter-btn').on('click', function() {
        const tag = $(this).data('tag');
        selectTag(tag);
    });
}

function selectTag(tag) {
    $('#selected-tag').val(tag);
    $('#clear-tag-filter').show();
    renderTags();

    // Auto-search se c'Ã¨ una query
    const query = $('#search-query').val().trim();
    if (query) {
        performSearch(query);
    }
}

// Clear tag filter
$('#clear-tag-filter').on('click', function() {
    $('#selected-tag').val('');
    $(this).hide();
    renderTags();

    // Auto-search se c'Ã¨ una query
    const query = $('#search-query').val().trim();
    if (query) {
        performSearch(query);
    }
});

// Handle search form
$('#search-form').on('submit', function(e) {
    e.preventDefault();

    const query = $('#search-query').val().trim();
    if (!query) return;

    performSearch(query);
});

function performSearch(query) {
    // Update counter
    searchCounter++;
    $('#search-count').text(searchCounter);

    // Show loading
    $('#loading').show();
    $('#answer-section').hide();
    $('#results-section').hide();

    // Get selected tag filter
    const tagFilter = $('#selected-tag').val();

    // API call
    $.ajax({
        url: '/api/search',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            query: query,
            size: 10,
            use_rag: true,
            tag_filter: tagFilter
        }),
        success: function(response) {
            $('#loading').hide();

            if (response.success) {
                displayAnswer(response);
                displayResults(response.results);
            } else {
                showError(response.error);
            }
        },
        error: function(xhr, status, error) {
            $('#loading').hide();
            showError('Errore durante la ricerca: ' + error);
        }
    });
}

function displayAnswer(response) {
    // Answer text
    $('#answer-text').html(response.answer.replace(/\n/g, '<br>'));

    // Confidence
    const confidence = response.confidence * 100;
    $('#confidence-fill').css('width', confidence + '%');
    $('#confidence-text').text(`${confidence.toFixed(0)}% - ${getConfidenceLabel(response.confidence)}`);

    // Sources
    let sourcesHtml = '<ul class="list-unstyled">';
    response.sources.forEach(source => {
        sourcesHtml += `
            <li>
                <i class="fas fa-file text-primary"></i>
                <strong>${source.filename}</strong>
                <span class="badge badge-info">${source.score}</span>
            </li>
        `;
    });
    sourcesHtml += '</ul>';
    $('#sources-list').html(sourcesHtml);

    // Flow
    let flowHtml = '';
    response.flow.forEach((step, index) => {
        flowHtml += `
            <div class="flow-step">
                <strong>${step}</strong>
            </div>
        `;
    });
    $('#flow-steps').html(flowHtml);

    // Suggestions
    let suggestionsHtml = '';
    response.suggestions.forEach(suggestion => {
        suggestionsHtml += `
            <button class="btn btn-sm btn-outline-warning m-1 suggestion-btn">
                <i class="fas fa-arrow-right"></i> ${suggestion}
            </button>
        `;
    });
    $('#suggestions-list').html(suggestionsHtml);

    // Suggestion click handlers
    $('.suggestion-btn').on('click', function() {
        const suggestion = $(this).text().replace('Cerca anche: ', '').trim();
        $('#search-query').val(suggestion);
        performSearch(suggestion);
    });

    $('#answer-section').show();
}

function displayResults(results) {
    $('#results-count').text(results.length);

    let html = '';
    results.forEach((result, index) => {
        const keywords = result.keywords.slice(0, 5).map(kw =>
            `<span class="keyword-badge">${kw}</span>`
        ).join(' ');

        const tags = (result.tags || []).map(tag =>
            `<span class="badge badge-success clickable-tag" data-tag="${tag}" style="cursor: pointer;">
                <i class="fas fa-tag"></i> ${tag}
            </span>`
        ).join(' ');

        html += `
            <div class="card search-result mb-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-file-${getFileIcon(result.extension)} text-primary"></i>
                        ${result.filename}
                        <span class="badge badge-primary float-right">${result.score.toFixed(2)}</span>
                    </h5>
                    <p class="card-text">
                        <span class="badge badge-secondary">${result.type}</span>
                        ${result.extension}
                        <span class="text-muted ml-2">${formatSize(result.file_size)}</span>
                    </p>
                    <div class="highlight">
                        ${result.highlight}
                    </div>
                    <div class="mt-2">
                        ${keywords}
                        ${tags}
                    </div>
                    <div class="mt-3">
                        <a href="/api/download/${result.id}" class="btn btn-sm btn-success" target="_blank">
                            <i class="fas fa-download"></i> Scarica File
                        </a>
                        <button class="btn btn-sm btn-info" onclick="viewDocument('${result.id}')">
                            <i class="fas fa-eye"></i> Dettagli
                        </button>
                    </div>
                </div>
            </div>
        `;
    });

    $('#results-container').html(html);

    // Make tags clickable
    $('.clickable-tag').on('click', function() {
        const tag = $(this).data('tag');
        selectTag(tag);

        // Scroll to top
        $('html, body').animate({
            scrollTop: $('#tags-container').offset().top - 100
        }, 500);
    });

    $('#results-section').show();
}

function getConfidenceLabel(confidence) {
    if (confidence >= 0.8) return 'Molto Alta';
    if (confidence >= 0.6) return 'Alta';
    if (confidence >= 0.4) return 'Media';
    if (confidence >= 0.2) return 'Bassa';
    return 'Molto Bassa';
}

// ============ TAB: DOCUMENTI ============

function loadDocuments() {
    $('#docs-loading').show();
    $('#docs-container').hide();

    $.ajax({
        url: '/api/documents?size=100',
        method: 'GET',
        success: function(response) {
            $('#docs-loading').hide();
            $('#docs-container').show();

            if (response.success) {
                allDocuments = response.documents;
                applyDocumentFilters(); // Applica filtri e renderizza
            } else {
                showError(response.error);
            }
        },
        error: function(xhr, status, error) {
            $('#docs-loading').hide();
            showError('Errore durante il caricamento: ' + error);
        }
    });
}

function renderDocuments() {
    const tbody = $('#docs-tbody');
    tbody.empty();

    if (filteredDocuments.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="6" class="text-center text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Nessun documento trovato</p>
                    ${allDocuments.length > 0 ? '<p class="text-muted">Prova a modificare i filtri</p>' : '<a href="/upload" class="btn btn-primary"><i class="fas fa-upload"></i> Carica il primo documento</a>'}
                </td>
            </tr>
        `);
        $('#docs-info').text('Nessun documento');
        $('#pagination').empty();
        return;
    }

    // Paginate
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageDocuments = filteredDocuments.slice(start, end);

    pageDocuments.forEach(doc => {
        const keywords = (doc.keywords || []).slice(0, 3).map(kw =>
            `<span class="badge badge-secondary">${kw}</span>`
        ).join(' ');

        const tags = (doc.tags || []).map(tag =>
            `<span class="badge badge-success"><i class="fas fa-tag"></i> ${tag}</span>`
        ).join(' ');

        const keywordsTags = [keywords, tags].filter(x => x).join(' ');

        const date = new Date(doc.indexed_at).toLocaleString('it-IT');

        const row = `
            <tr>
                <td>
                    <i class="fas fa-file-${getFileIcon(doc.extension)} text-primary"></i>
                    <strong>${getDisplayFilename(doc.filename)}</strong>
                </td>
                <td><span class="badge badge-info">${doc.type}</span></td>
                <td>${formatSize(doc.file_size)}</td>
                <td><small>${date}</small></td>
                <td>${keywordsTags || '<em class="text-muted">Nessuno</em>'}</td>
                <td class="text-nowrap">
                    <a href="/api/download/${doc.id}" class="btn btn-sm btn-success" target="_blank" title="Scarica file">
                        <i class="fas fa-download"></i> Scarica
                    </a>
                    <button class="btn btn-sm btn-info" onclick="viewDocument('${doc.id}')" title="Vedi dettagli">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDocument('${doc.id}', '${doc.filename}')" title="Elimina documento">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;

        tbody.append(row);
    });

    // Update info
    const startNum = filteredDocuments.length > 0 ? start + 1 : 0;
    const endNum = Math.min(end, filteredDocuments.length);
    $('#docs-info').text(`Mostrando ${startNum}-${endNum} di ${filteredDocuments.length} documenti`);

    // Render pagination
    renderPagination();
}

function renderPagination() {
    const totalPages = Math.ceil(filteredDocuments.length / pageSize);
    const pagination = $('#pagination');
    pagination.empty();

    if (totalPages <= 1) return;

    // Previous
    pagination.append(`
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `);

    // Pages
    for (let i = 1; i <= totalPages; i++) {
        pagination.append(`
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `);
    }

    // Next
    pagination.append(`
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `);
}

function changePage(page) {
    const totalPages = Math.ceil(filteredDocuments.length / pageSize);
    if (page < 1 || page > totalPages) return;

    currentPage = page;
    renderDocuments();
    return false;
}

function viewDocument(docId) {
    $.ajax({
        url: `/api/document/${docId}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                showDocumentDetail(response.document);
            } else {
                showError(response.error);
            }
        },
        error: function(xhr, status, error) {
            showError('Errore: ' + error);
        }
    });
}

function showDocumentDetail(doc) {
    $('#modal-title').text(getDisplayFilename(doc.filename));

    const keywords = (doc.keywords || []).map(kw =>
        `<span class="badge badge-secondary">${kw}</span>`
    ).join(' ');

    const tags = (doc.tags || []).map(tag =>
        `<span class="badge badge-success"><i class="fas fa-tag"></i> ${tag}</span>`
    ).join(' ');

    let tagsHtml = '';
    if (tags) {
        tagsHtml = `
            <hr>
            <div>
                <strong>Tags:</strong><br>
                ${tags}
            </div>
        `;
    }

    const modalContent = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Tipo:</strong> ${doc.type}</p>
                <p><strong>Estensione:</strong> ${doc.extension}</p>
                <p><strong>Dimensione:</strong> ${formatSize(doc.file_size)}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Indicizzato:</strong> ${new Date(doc.indexed_at).toLocaleString('it-IT')}</p>
                <p><strong>Path:</strong> <code>${doc.file_path}</code></p>
            </div>
        </div>
        <hr>
        <div>
            <strong>Keywords:</strong><br>
            ${keywords || '<em class="text-muted">Nessuno</em>'}
        </div>
        ${tagsHtml}
        <hr>
        <div>
            <strong>Summary:</strong>
            <p>${doc.summary}</p>
        </div>
        <hr>
        <div>
            <strong>Contenuto (anteprima):</strong>
            <pre style="max-height: 300px; overflow-y: auto;">${doc.content.substring(0, 1000)}...</pre>
        </div>
    `;

    $('#modal-body').html(modalContent);

    // Aggiorna link download nel modale
    $('#modal-download-btn').attr('href', `/api/download/${doc.id}`);

    $('#doc-modal').modal('show');
}

function deleteDocument(docId, filename) {
    if (!confirm(`Sei sicuro di voler eliminare "${filename}"?`)) {
        return;
    }

    $.ajax({
        url: `/api/document/${docId}`,
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                alert('âœ… Documento eliminato con successo');
                loadDocuments();
            } else {
                showError(response.error);
            }
        },
        error: function(xhr, status, error) {
            showError('Errore durante l\'eliminazione: ' + error);
        }
    });
}

function applyFilters() {
    // TODO: Implement filters
    alert('Filtri in via di implementazione');
}

function applyDocumentFilters() {
    // Ottieni i valori dei filtri
    const nameFilter = $('#filter-name').val().toLowerCase().trim();
    const typeFilter = $('#filter-type').val();
    const sortBy = $('#sort-by').val();

    // Filtra documenti
    filteredDocuments = allDocuments.filter(doc => {
        // Filtro per nome
        if (nameFilter && !doc.filename.toLowerCase().includes(nameFilter)) {
            return false;
        }

        // Filtro per tipo
        if (typeFilter && doc.extension !== typeFilter) {
            return false;
        }

        return true;
    });

    // Ordina documenti
    filteredDocuments.sort((a, b) => {
        if (sortBy === 'filename') {
            return a.filename.localeCompare(b.filename);
        } else if (sortBy === 'size') {
            return (b.file_size || 0) - (a.file_size || 0); // PiÃ¹ grande prima
        } else { // indexed_at (default)
            const dateA = new Date(a.indexed_at);
            const dateB = new Date(b.indexed_at);
            return dateB - dateA; // PiÃ¹ recente prima
        }
    });

    // Reset alla prima pagina
    currentPage = 1;

    // Renderizza
    renderDocuments();
}

// ============ SHARED UTILITIES ============

function getDisplayFilename(filename) {
    // Rimuovi timestamp dal nome file (formato: YYYYMMDD_HHMMSS_* o YYYYMMDD_HHMMSS_MICROSECONDS_*)
    // Esempi: 20251110_114757_557040_file.pdf -> file.pdf
    //         20251110_114757_file.pdf -> file.pdf
    if (filename.match(/^\d{8}_\d{6}_(\d+_)?/)) {
        // Trova la posizione dopo il timestamp
        const parts = filename.split('_');
        if (parts.length >= 3) {
            // Se c'Ã¨ un terzo gruppo di cifre (microsecondi), rimuovi anche quello
            if (parts[2] && /^\d+$/.test(parts[2])) {
                return parts.slice(3).join('_');
            }
            // Altrimenti rimuovi solo data e ora
            return parts.slice(2).join('_');
        }
    }
    return filename;
}

function getFileIcon(extension) {
    const icons = {
        '.pdf': 'pdf',
        '.doc': 'word',
        '.docx': 'word',
        '.xls': 'excel',
        '.xlsx': 'excel',
        '.html': 'code',
        '.md': 'markdown',
        '.txt': 'alt',
        '.csv': 'csv',
        '.msg': 'envelope',
        '.pst': 'archive',
        '.zip': 'archive',
        '.xml': 'code',
        '.json': 'code',
        '.rtf': 'alt',
        '.odt': 'alt',
        '.pptx': 'powerpoint'
    };
    return icons[extension] || 'alt';
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / 1024 / 1024).toFixed(2) + ' MB';
}

function showError(message) {
    alert('Errore: ' + message);
}
</script>
{% endblock %}
